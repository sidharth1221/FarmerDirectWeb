<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmerDirect</title>
    
    <!-- FIX: Corrected src attribute -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- FIX: Corrected href attributes -->
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2A5B3D",
                        "primary-accent": "#FFA500",
                        "background-light": "#F8F9FA",
                        "background-dark": "#102210",
                        "bubble-light": "#E9E5D7",
                        "bubble-dark": "#2a3a2a",
                        "bubble-user-light": "#DAE8DB",
                        "bubble-user-dark": "#224422",
                        "text-light": "#1f2937",
                        "text-dark": "#f3f4f6",
                        "text-muted-light": "#6b7280",
                        "text-muted-dark": "#9ca3af",
                        "border-light": "#e5e7eb",
                        "border-dark": "#374151",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#1C252E",
                    },
                    fontFamily: {
                        "display": ["Lexend", "sans-serif"]
                    },
                    borderRadius: { "lg": "0.75rem", "xl": "1rem" },
                    animation: {
                        'bounce-slow': 'bounce 1.5s infinite',
                    }
                }
            }
        }
    </script>
    
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
        body { font-family: 'Lexend', sans-serif; background-color: theme('colors.background-light'); color: theme('colors.text-light'); }
        .dark body { background-color: theme('colors.background-dark'); color: theme('colors.text-dark'); }
        .chat-feed::-webkit-scrollbar { width: 6px; }
        .chat-feed::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        .chat-feed::-webkit-scrollbar-thumb:hover { background: #555; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .file-preview-badge {
            position: relative; display: inline-flex; align-items: center;
            background-color: #eef2ff; color: #4338ca; font-size: 0.875rem;
            font-weight: 500; padding: 0.25rem 0.75rem; border-radius: 9999px;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .file-preview-badge-remove {
            margin-left: 0.5rem; padding: 0.25rem; border-radius: 9999px;
            cursor: pointer; transition: background-color 0.15s ease-in-out;
        }
        .file-preview-badge-remove:hover { background-color: #e0e7ff; }
    </style>
</head>
<body class="antialiased">
    
    <div id="app" class="relative flex min-h-screen w-full flex-col">
        <!-- Initial Loading State -->
        <div class="flex h-screen w-full items-center justify-center">
            <p class="text-lg text-text-muted-light">Loading FarmerDirect...</p>
        </div>
    </div>

    <script>
        // --- API & State Management ---
        const API_BASE_URL = "http://localhost:8000/api/v1"; // Ensure your backend is running here
        const app = document.getElementById('app');
        
        let aiChatHistory = [
            {
                sender: 'ai',
                text: "Hello! I am your AI Farmer's Assistant. Upload a photo of a diseased plant or ask me a question about market prices."
            }
        ];
        
        let listingFiles = [];
        let currentUser = null;
        let messagePollingInterval = null; // For polling chat messages

        // --- Helper Functions ---

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64)
                        .split('')
                        .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                        .join('')
                );
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("Failed to decode JWT:", e);
                return null;
            }
        }
        
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // --- Main App Router ---
        
        async function router() {
            // Stop any active polling when we change pages
            if (messagePollingInterval) {
                clearInterval(messagePollingInterval);
                messagePollingInterval = null;
            }
            
            const token = localStorage.getItem('token');
            const userJson = localStorage.getItem('user');
            currentUser = userJson ? JSON.parse(userJson) : null;

            let hash = window.location.hash || (token ? '#dashboard' : '#login');

            app.innerHTML = ''; // Clear the app container

            // --- Auth Guards ---
            if (!currentUser && (hash !== '#login' && hash !== '#register')) {
                window.location.hash = '#login';
                return;
            }
            if (currentUser && (hash === '#login' || hash === '#register')) {
                window.location.hash = '#dashboard';
                return;
            }
            // --- Role Guard ---
            if (currentUser && currentUser.role === 'buyer' && (hash === '#ai-assistant' || hash === '#create-listing')) {
                console.warn("Access Denied: Buyers cannot access this page.");
                window.location.hash = '#dashboard';
                return;
            }

            // --- Page Router ---
            if (hash.startsWith('#messages/')) {
                // --- Dynamic Chat Page ---
                const chatId = hash.split('/')[1];
                app.innerHTML = renderDashboardLayout('messages', renderChatPage(chatId), currentUser.role);
                attachDashboardListeners();
                attachChatListeners(chatId); // Attach listeners for the chat page
            } else {
                switch (hash) {
                    case '#login':
                        app.innerHTML = renderLoginPage();
                        attachLoginListeners();
                        break;
                    case '#register':
                        app.innerHTML = renderRegisterPage();
                        attachRegisterListeners();
                        break;
                    case '#dashboard':
                        app.innerHTML = renderDashboardLayout('dashboard', renderMarketplacePage(), currentUser.role);
                        attachDashboardListeners();
                        fetchAndRenderListings();
                        break;
                    case '#messages': // --- Conversation List Page ---
                        app.innerHTML = renderDashboardLayout('messages', renderMessagesListPage(), currentUser.role);
                        attachDashboardListeners();
                        fetchAndRenderConversations();
                        break;
                    case '#ai-assistant':
                        app.innerHTML = renderDashboardLayout('ai-assistant', renderAiAssistantPage(), currentUser.role);
                        attachDashboardListeners();
                        attachAiAssistantListeners();
                        break;
                    case '#create-listing':
                        app.innerHTML = renderDashboardLayout('create-listing', renderCreateListingPage(), currentUser.role);
                        attachDashboardListeners();
                        attachCreateListingListeners();
                        break;
                    default:
                        window.location.hash = '#dashboard';
                }
            }
        }
        
        // --- 1. LOGIN PAGE ---
        function renderLoginPage() {
            return `
                <header class="absolute top-0 left-0 right-0 z-10 px-4 sm:px-6 lg:px-8 py-4">
                    <div class="mx-auto flex max-w-7xl items-center justify-between">
                        <a href="#" class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-3xl">grass</span>
                            <h2 class="text-xl font-bold text-text-light dark:text-text-dark">FarmerDirect</h2>
                        </a>
                        <div class="flex items-center gap-4">
                            <span class="hidden text-sm sm:inline text-text-light dark:text-text-dark">Don't have an account?</span>
                            <a href="#register" class="flex h-10 cursor-pointer items-center justify-center rounded-lg bg-primary/10 px-4 text-sm font-bold text-primary transition-colors hover:bg-primary/20">
                                Sign Up
                            </a>
                        </div>
                    </div>
                </header>
                <main class="flex flex-1">
                    <div class="grid w-full grid-cols-1 lg:grid-cols-2">
                        <div class="relative hidden h-full min-h-screen flex-col justify-between bg-zinc-900 p-10 lg:flex">
                            <div class="absolute inset-0">
                                <!-- FIX: Corrected img src -->
                                <img class="h-full w-full object-cover opacity-30" alt="Farmer in a field" src="https://images.unsplash.com/photo-1620141692398-51c800f072cc?w=1080">
                            </div>
                            <div class="relative z-10 mt-auto text-white">
                                <h1 class="mb-4 text-5xl font-black">Connecting Fields to Markets, with Trust.</h1>
                                <p class="text-lg text-white/80">Get fair prices and direct access to a trusted network of buyers.</p>
                            </div>
                        </div>
                        <div class="flex w-full min-h-screen items-center justify-center bg-background-light dark:bg-background-dark p-4 sm:p-8">
                            <div class="w-full max-w-md space-y-8">
                                <div class="text-center">
                                    <h2 class="text-3xl font-bold tracking-tight text-text-light dark:text-text-dark">Welcome Back</h2>
                                    <p class="mt-2 text-sm text-text-light/70 dark:text-text-dark/70">Sign in to your account</p>
                                </div>
                                <form id="login-form" class="space-y-6">
                                    <div class="space-y-4">
                                        <label class="flex flex-col">
                                            <p class="pb-2 text-sm font-medium text-text-light dark:text-text-dark">Email Address</p>
                                            <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="Enter your email" type="email" id="email" required>
                                        </label>
                                        <label class="flex flex-col">
                                            <p class="pb-2 text-sm font-medium text-text-light dark:text-text-dark">Password</p>
                                            <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="Enter your password" type="password" id="password" required>
                                        </label>
                                    </div>
                                    <div id="error-message" class="text-sm text-red-600 p-3 bg-red-50 rounded-lg hidden"></div>
                                    <button type="submit" id="login-button" class="flex h-12 w-full items-center justify-center rounded-lg bg-primary px-5 text-base font-bold text-white shadow-lg transition-all hover:bg-primary/90">
                                        Log In
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }
        
        // --- 2. REGISTER PAGE ---
        function renderRegisterPage() {
            return `
                <header class="absolute top-0 left-0 right-0 z-10 px-4 sm:px-6 lg:px-8 py-4">
                    <div class="mx-auto flex max-w-7xl items-center justify-between">
                         <a href="#" class="flex items-center gap-3">
                            <span class="material-symbols-outlined text-primary text-3xl">grass</span>
                            <h2 class="text-xl font-bold text-text-light dark:text-text-dark">FarmerDirect</h2>
                        </a>
                        <div class="flex items-center gap-4">
                            <span class="hidden text-sm sm:inline text-text-light dark:text-text-dark">Already have an account?</span>
                            <a href="#login" class="flex h-10 cursor-pointer items-center justify-center rounded-lg bg-primary/10 px-4 text-sm font-bold text-primary transition-colors hover:bg-primary/20">
                                Log In
                            </a>
                        </div>
                    </div>
                </header>
                <main class="flex flex-1">
                    <div class="grid w-full grid-cols-1 lg:grid-cols-2">
                        <div class="relative hidden h-full min-h-screen flex-col justify-between bg-zinc-900 p-10 lg:flex">
                            <div class="absolute inset-0">
                                <!-- FIX: Corrected img src -->
                                <img class="h-full w-full object-cover opacity-30" alt="Farmer in a field" src="https://images.unsplash.com/photo-1620141692398-51c800f072cc?w=1080">
                            </div>
                            <div class="relative z-10 mt-auto text-white">
                                <h1 class="mb-4 text-5xl font-black">Connecting Fields to Markets, with Trust.</h1>
                                <p class="text-lg text-white/80">Get fair prices and direct access to a trusted network of buyers.</p>
                            </div>
                        </div>
                        <div class="flex w-full min-h-screen items-center justify-center bg-background-light dark:bg-background-dark p-4 sm:p-8">
                            <div class="w-full max-w-md space-y-8">
                                <div class="text-center">
                                    <h2 class="text-3xl font-bold tracking-tight text-text-light dark:text-text-dark">Create Your Account</h2>
                                    <p class="mt-2 text-sm text-text-light/70 dark:text-text-dark/70">Join FarmerDirect and unlock new opportunities.</p>
                                </div>
                                <form id="register-form" class="space-y-6">
                                    <div>
                                        <div class="flex h-12 flex-1 items-center justify-center rounded-lg bg-black/5 p-1 dark:bg-white/5">
                                            <label class="flex h-full flex-1 cursor-pointer items-center justify-center gap-2 rounded-md px-2 text-sm font-medium leading-normal has-[:checked]:bg-surface-light has-[:checked]:text-text-light has-[:checked]:shadow-sm">
                                                <span class="material-symbols-outlined text-base">grass</span>
                                                <span class="truncate">I am a Farmer</span>
                                                <input class="invisible w-0" name="role" type="radio" value="farmer" checked>
                                            </label>
                                            <label class="flex h-full flex-1 cursor-pointer items-center justify-center gap-2 rounded-md px-2 text-sm font-medium leading-normal has-[:checked]:bg-surface-light has-[:checked]:text-text-light has-[:checked]:shadow-sm">
                                                <span class="material-symbols-outlined text-base">storefront</span>
                                                <span class="truncate">I am a Buyer</span>
                                                <input class="invisible w-0" name="role" type="radio" value="buyer">
                                            </label>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <label class="flex flex-col">
                                            <p class="pb-2 text-sm font-medium text-text-light dark:text-text-dark">Full Name</p>
                                            <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="Enter your full name" type="text" id="fullName" required>
                                        </label>
                                        <label class="flex flex-col">
                                            <p class="pb-2 text-sm font-medium text-text-light dark:text-text-dark">Email Address</p>
                                            <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="Enter your email" type="email" id="email" required>
                                        </label>
                                        <label class="flex flex-col">
                                            <p class="pb-2 text-sm font-medium text-text-light dark:text-text-dark">Password</p>
                                            <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="Create a strong password" type="password" id="password" required>
                                        </label>
                                    </div>
                                    <div id="error-message" class="text-sm text-red-600 p-3 bg-red-50 rounded-lg hidden"></div>
                                    <div id="success-message" class="text-sm text-green-600 p-3 bg-green-50 rounded-lg hidden"></div>
                                    <button type="submit" id="register-button" class="flex h-12 w-full items-center justify-center rounded-lg bg-primary px-5 text-base font-bold text-white shadow-lg transition-all hover:bg-primary/90">
                                        Create My Account
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </main>
            `;
        }

        // --- 3. DASHBOARD LAYOUT (NOW WITH "MESSAGES" LINK) ---
        function renderDashboardLayout(activePage, contentHtml, userRole) {
            let pageTitle = activePage.replace('-', ' ');
            if (activePage.startsWith('messages')) { // Catches 'messages' and 'messages/...'
                pageTitle = "Messages";
            }
            
            return `
                <div class="flex h-screen w-full">
                    <aside class="hidden md:flex flex-col w-64 border-r border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark">
                        <div class="flex h-16 items-center justify-center border-b border-border-light dark:border-border-dark">
                            <a href="#dashboard" class="flex items-center gap-3">
                                <span class="material-symbols-outlined text-primary text-3xl">grass</span>
                                <h2 class="text-xl font-bold text-text-light dark:text-text-dark">FarmerDirect</h2>
                            </a>
                        </div>
                        <nav class="flex-1 p-4 space-y-2">
                            <a href="#dashboard" class="flex items-center gap-3 px-3 py-2 rounded-lg ${activePage === 'dashboard' ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-white/5'}">
                                <span class="material-symbols-outlined">storefront</span>
                                <p class="text-sm font-medium">Marketplace</p>
                            </a>
                            
                            <!-- Messages link for EVERYONE -->
                            <a href="#messages" class="flex items-center gap-3 px-3 py-2 rounded-lg ${activePage.startsWith('messages') ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-white/5'}">
                                <span class="material-symbols-outlined">chat</span>
                                <p class="text-sm font-medium">Messages</p>
                            </a>
                            
                            <!-- FARMER-ONLY LINKS -->
                            ${userRole === 'farmer' ? `
                            <a href="#ai-assistant" class="flex items-center gap-3 px-3 py-2 rounded-lg ${activePage === 'ai-assistant' ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-white/5'}">
                                <span class="material-symbols-outlined">smart_toy</span>
                                <p class="text-sm font-medium">AI Assistant</p>
                            </a>
                            <a href="#create-listing" class="flex items-center gap-3 px-3 py-2 rounded-lg ${activePage === 'create-listing' ? 'bg-primary/10 text-primary' : 'hover:bg-gray-100 dark:hover:bg-white/5'}">
                                <span class="material-symbols-outlined">add_circle</span>
                                <p class="text-sm font-medium">Create Listing</p>
                            </a>
                            ` : ''}
                            <!-- END FARMER-ONLY LINKS -->
                            
                        </nav>
                        <div class="p-4 border-t border-border-light dark:border-border-dark">
                            <button id="logout-button" class="flex w-full items-center justify-center rounded-lg h-10 px-4 bg-red-500/10 text-red-600 text-sm font-bold hover:bg-red-500/20">
                                Logout
                            </button>
                        </div>
                    </aside>
                    
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <header class="flex items-center gap-4 px-6 h-16 justify-between border-b border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark">
                            <div>
                                <h1 class="text-xl font-bold capitalize">${pageTitle}</h1>
                            </div>
                            <div class="flex items-center gap-4">
                                ${userRole === 'farmer' ? `
                                <a href="#create-listing" class="flex min-w-[84px] cursor-pointer items-center justify-center rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold hover:bg-primary/90">
                                    Create Listing
                                </a>
                                ` : ''}
                                <!-- FIX: Corrected img src -->
                                <img class="h-10 w-10 rounded-full" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop" alt="User profile"/>
                            </div>
                        </header>
                        
                        <main class="flex-1 overflow-y-auto p-0 bg-background-light dark:bg-background-dark">
                            <!-- Page content is rendered here. Padding is handled by child pages. -->
                            ${contentHtml}
                        </main>
                    </div>
                </div>
            `;
        }
        
        // --- 4. MARKETPLACE PAGE (ROLE-AWARE BUTTONS) ---
        function renderMarketplacePage() {
            return `
                <div class="flex flex-col lg:flex-row gap-8 p-6 lg:p-8">
                    <aside class="w-full lg:w-1/4 xl:w-1/5">
                        <div class="sticky top-8 space-y-6">
                            <h2 class="text-lg font-bold text-text-light dark:text-text-dark">Filter Listings</h2>
                            <!-- ... filters ... -->
                        </div>
                    </aside>
                    <section class="w-full lg:w-3/4 xl:w-4/5">
                        <div id="listing-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                            <div class="p-6 text-center md:col-span-2 xl:col-span-3">
                                <p class="text-text-muted-light">Loading listings...</p>
                            </div>
                        </div>
                    </section>
                </div>
            `;
        }
        
        async function fetchAndRenderListings() {
            const grid = document.getElementById('listing-grid');
            if (!grid) return;
            try {
                const response = await fetch(`${API_BASE_URL}/listings`, { method: 'GET', headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Failed to fetch listings');
                const listings = await response.json();
                if (listings.length === 0) {
                    grid.innerHTML = `<p class="p-6 text-center md:col-span-2 xl:col-span-3 text-text-muted-light">No active listings found.</p>`;
                    return;
                }
                grid.innerHTML = listings.map(listing => renderListingCard(listing)).join('');
            } catch (err) {
                grid.innerHTML = `<p class="p-6 text-center md:col-span-2 xl:col-span-3 text-red-600">Error: ${err.message}</p>`;
            }
        }

        function renderListingCard(listing) {
            // FIX: Corrected img src
            const farmerImg = "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop";
            // FIX: Corrected img src fallback
            const mainImg = (listing.image_urls && listing.image_urls.length > 0) 
                ? listing.image_urls[0] 
                : 'https://images.unsplash.com/photo-1586994436733-59c3ea7363f7?w=400';

            // --- Role-based button ---
            let actionButtonHtml = '';
            if (currentUser.role === 'buyer') {
                actionButtonHtml = `
                    <button class="flex items-center justify-center rounded-lg h-9 px-3 bg-primary/10 text-primary text-sm font-bold hover:bg-primary/20"
                            onclick="handleMakeOffer('${listing.id}')">
                        <span class="truncate">Make Offer</span>
                    </button>
                `;
            } else if (currentUser.email === listing.owner_email) {
                // Farmer is viewing their OWN listing
                 actionButtonHtml = `
                    <button class="flex items-center justify-center rounded-lg h-9 px-3 bg-gray-500/10 text-gray-600 text-sm font-bold cursor-not-allowed">
                        <span class="truncate">Your Listing</span>
                    </button>
                `;
            }
            // If farmer is viewing *another* farmer's listing, no button shows.
            
            return `
                <div class="flex flex-col bg-surface-light dark:bg-surface-dark rounded-xl overflow-hidden border border-border-light dark:border-border-dark shadow-sm transition-all hover:shadow-lg hover:-translate-y-1">
                    <div class="relative">
                        <div class="bg-center bg-no-repeat aspect-video bg-cover" style="background-image: url('${mainImg}')"></div>
                        <div class="absolute top-3 left-3 flex items-center gap-1.5 bg-primary-accent/90 text-black font-bold text-xs px-2 py-1 rounded-full">
                            <span class="material-symbols-outlined text-sm" style="font-variation-settings: 'FILL' 1;">verified</span>
                            <span>Grade (YOLO) ${listing.ai_grade || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="text-lg font-bold text-text-light dark:text-text-dark">${listing.title}</h3>
                        <div class="flex items-center gap-2 text-text-muted-light dark:text-text-muted-dark mt-1">
                            <span class="material-symbols-outlined text-base">location_on</span>
                            <p class="text-sm font-medium">${listing.location}</p>
                        </div>
                        <p class="text-2xl font-black text-text-light dark:text-text-dark mt-3">${listing.ai_price_range || 'Contact'} <span class="text-base font-medium text-text-light/70">/ ${listing.quantity_unit}</span></p>
                        <div class="border-t border-border-light dark:border-border-dark mt-4 pt-3 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8" src="${farmerImg}" />
                                <p class="text-sm font-medium text-text-light dark:text-text-dark">${listing.owner_email.split('@')[0]}</p>
                            </div>
                            ${actionButtonHtml}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- Handle Make Offer Click ---
        async function handleMakeOffer(listingId) {
            // This function is called from the button
            console.log(`Initiating chat for listing: ${listingId}`);
            try {
                const response = await fetch(`${API_BASE_URL}/chat/initiate`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ listing_id: listingId })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.detail || 'Failed to start chat');
                
                // Redirect to the new chat page
                window.location.hash = `#messages/${data.chat_id}`;
                
            } catch (err) {
                // Using alert for simplicity in error case
                console.error("Error making offer:", err);
                alert(`Error: ${err.message}`);
            }
        }

        // --- 5. AI ASSISTANT PAGE ---
        function renderAiAssistantPage() {
            let messagesHtml = aiChatHistory.map(msg => renderAiChatMessage(msg.sender, msg.text, msg.imageUrl)).join('');
            return `
                <!-- FIX: Changed h-[calc(...)] to h-full -->
                <div class="flex flex-1 flex-col bg-gray-50 dark:bg-black/20 h-full p-6 lg:p-8">
                    <div id="message-feed" class="flex-1 overflow-y-auto space-y-6 chat-feed pr-4">
                        ${messagesHtml}
                    </div>
                    
                    <footer class="pt-6">
                        <form id="chat-form" class="flex items-center gap-4 rounded-lg border border-border-light bg-surface-light px-4 py-2 focus-within:ring-2 focus-within:ring-primary">
                            <input type="file" id="file-input" class="hidden" accept="image/*">
                            <button type="button" id="file-button" class="text-text-muted-light hover:text-primary">
                                <span class="material-symbols-outlined">attachment</span>
                            </button>
                            <input id="chat-input" class="flex-1 w-full bg-transparent border-none text-base p-0 focus:ring-0 placeholder:text-text-muted-light" placeholder="Ask about weather, crops, or market prices..." type="text">
                            <button type="submit" id="chat-send-button" class="flex items-center justify-center shrink-0 size-10 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </form>
                    </footer>
                </div>
            `;
        }
        
        function renderAiChatMessage(sender, text, imageUrl) {
            // FIX: Corrected img src
            const aiAvatar = "https://img.icons8.com/color/96/potted-plant.png";
            // FIX: Corrected img src
            const userAvatar = "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop";

            if (sender === 'ai') {
                return `
                <div class="flex items-end gap-3 p-0">
                    <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0" src="${aiAvatar}">
                    <div class="flex flex-1 flex-col gap-1 items-start">
                        <p class="text-primary dark:text-primary-accent text-[13px] font-medium">AI Assistant</p>
                        <p class="text-base font-normal leading-relaxed flex max-w-[480px] rounded-lg rounded-bl-none px-4 py-3 bg-bubble-light dark:bg-bubble-dark text-text-light dark:text-text-dark">
                            ${text}
                        </p>
                    </div>
                </div>
                `;
            }
            return `
                <div class="flex items-end gap-3 p-0 justify-end">
                    <div class="flex flex-1 flex-col gap-1 items-end">
                        <p class="text-text-muted-light dark:text-text-muted-dark text-[13px] font-medium text-right">You</p>
                        ${imageUrl ? `<img src="${imageUrl}" alt="User upload" class="w-64 max-w-xs rounded-lg shadow-md mb-2">` : ''}
                        ${text ? `<p class="text-base font-normal leading-relaxed flex max-w-[480px] rounded-lg rounded-br-none px-4 py-3 bg-bubble-user-light dark:bg-bubble-user-dark text-text-light dark:text-text-dark">${text}</p>` : ''}
                    </div>
                    <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0" src="${userAvatar}">
                </div>
            `;
        }
        
        function renderAiTypingIndicator() {
             // FIX: Corrected img src
             const aiAvatar = "https://img.icons8.com/color/96/potted-plant.png";
             return `
                <div id="typing-indicator" class="flex items-end gap-3 p-0">
                    <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0" src="${aiAvatar}">
                    <div class="flex items-center space-x-1.5 rounded-lg rounded-bl-none px-4 py-3 bg-bubble-light dark:bg-bubble-dark">
                        <div class="h-2 w-2 bg-text-muted-light dark:bg-text-muted-dark rounded-full animate-bounce [animation-delay:-0.3s]"></div>
                        <div class="h-2 w-2 bg-text-muted-light dark:bg-text-muted-dark rounded-full animate-bounce [animation-delay:-0.15s]"></div>
                        <div class="h-2 w-2 bg-text-muted-light dark:bg-text-muted-dark rounded-full animate-bounce"></div>
                    </div>
                </div>
             `;
        }
        
        // --- 6. CREATE LISTING PAGE ---
        function renderCreateListingPage() {
            return `
                <div class="p-6 lg:p-8">
                <div class="max-w-2xl mx-auto bg-surface-light dark:bg-surface-dark p-8 rounded-lg shadow border border-border-light dark:border-border-dark">
                    <form id="listing-form" class="space-y-6">
                        <h2 class="text-2xl font-bold text-text-light dark:text-text-dark">Create New Produce Listing</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <label class="flex flex-col">
                                <p class="pb-2 text-sm font-medium">Listing Title</p>
                                <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="e.g., Fresh Sona Masoori Rice" type="text" id="title" required>
                            </label>
                            <label class="flex flex-col">
                                <p class="pb-2 text-sm font-medium">Location</p>
                                <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="e.g., Anantapur, AP" type="text" id="location" required>
                            </label>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <label class="flex flex-col">
                                <p class="pb-2 text-sm font-medium">Quantity</p>
                                <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" placeholder="10" type="number" id="quantity" required>
                            </label>
                            <label class="flex flex-col">
                                <p class="pb-2 text-sm font-medium">Unit</p>
                                <select id="quantity_unit" class="form-select w-full rounded-lg h-12 text-sm border-border-light bg-surface-light">
                                    <option>tonne</option>
                                    <option>quintal</option>
                                    <option>kg</option>
                                </select>
                            </label>
                            <label class="flex flex-col">
                                <p class="pb-2 text-sm font-medium">Harvest Date</p>
                                <input class="form-input flex h-12 w-full rounded-lg border border-border-light bg-surface-light p-3 text-sm" type="date" id="harvest_date" required>
                            </label>
                        </div>

                        <div>
                            <p class="pb-2 text-sm font-medium">Produce Images</p>
                            <p class="pb-4 text-sm text-text-muted-light">Upload at least 3 high-quality images. The YOLOv8 model will analyze these to grade your produce.</p>
                            <div class="flex items-center justify-center w-full">
                                <label for="listing-images" class="flex flex-col items-center justify-center w-full h-32 border-2 border-border-light border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-bray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <span class="material-symbols-outlined text-4xl text-text-muted-light">cloud_upload</span>
                                        <p class="mb-2 text-sm text-text-muted-light"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                    </div>
                                    <input id="listing-images" type="file" class="hidden" multiple accept="image/*" />
                                </label>
                            </div>
                            <div id="image-preview-container" class="flex flex-wrap gap-2 mt-4">
                            </div>
                        </div>

                        <div id="error-message" class="text-sm text-red-600 p-3 bg-red-50 rounded-lg hidden"></div>
                        <div id="success-message" class="text-sm text-green-600 p-3 bg-green-50 rounded-lg hidden"></div>
                        
                        <button type="submit" id="listing-submit-button" class="flex h-12 w-full items-center justify-center rounded-lg bg-primary px-5 text-base font-bold text-white shadow-lg transition-all hover:bg-primary/90">
                            Submit for YOLO Grading
                        </button>
                    </form>
                </div>
                </div>
            `;
        }

        // --- 7. NEW: MESSAGES LIST PAGE ---
        function renderMessagesListPage() {
            return `
                <div class="p-6 lg:p-8">
                    <h2 class="text-2xl font-bold text-text-light dark:text-text-dark mb-6">Your Conversations</h2>
                    <div id="conversations-list" class="space-y-4">
                        <p class="text-text-muted-light">Loading conversations...</p>
                    </div>
                </div>
            `;
        }
        
        async function fetchAndRenderConversations() {
            const listEl = document.getElementById('conversations-list');
            if (!listEl) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat/conversations`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                const conversations = await response.json();
                if (!response.ok) throw new Error(conversations.detail || 'Failed to load');
                
                if (conversations.length === 0) {
                    listEl.innerHTML = `<p class="text-text-muted-light">You have no active conversations.</p>`;
                    return;
                }
                
                listEl.innerHTML = conversations.map(chat => {
                    const otherUserEmail = (currentUser.email === chat.farmer_email) ? chat.buyer_email : chat.farmer_email;
                    return `
                        <a href="#messages/${chat.chat_id}" class="flex items-center gap-4 p-4 bg-surface-light dark:bg-surface-dark border border-border-light dark:border-border-dark rounded-lg shadow-sm hover:shadow-md transition-shadow">
                            <!-- FIX: Corrected img src -->
                            <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" src="https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop" />
                            <div class="flex-1">
                                <p class="font-bold text-text-light dark:text-text-dark">${otherUserEmail.split('@')[0]}</p>
                                <p class="text-sm text-text-muted-light dark:text-text-muted-dark">${chat.listing_title}</p>
                            </div>
                            <span class="material-symbols-outlined text-text-muted-light">chevron_right</span>
                        </a>
                    `;
                }).join('');
                
            } catch (err) {
                listEl.innerHTML = `<p class="text-red-600">Error: ${err.message}</p>`;
            }
        }
        
        // --- 8. NEW: CHAT PAGE ---
        function renderChatPage(chatId) {
            return `
                <!-- FIX: Changed h-[calc(...)] to h-full -->
                <div class="flex flex-1 flex-col bg-gray-50 dark:bg-black/20 h-full p-6 lg:p-8">
                    <div id="chat-message-feed" class="flex-1 overflow-y-auto space-y-6 chat-feed pr-4">
                        <p class="text-center text-text-muted-light">Loading messages...</p>
                    </div>
                    
                    <footer class="pt-6">
                        <form id="private-chat-form" class="flex items-center gap-4 rounded-lg border border-border-light bg-surface-light px-4 py-2 focus-within:ring-2 focus-within:ring-primary">
                            <input id="private-chat-input" class="flex-1 w-full bg-transparent border-none text-base p-0 focus:ring-0 placeholder:text-text-muted-light" placeholder="Type your message..." type="text">
                            <button type="submit" id="private-chat-send-button" class="flex items-center justify-center shrink-0 size-10 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
                                <span class="material-symbols-outlined">send</span>
                            </button>
                        </form>
                    </footer>
                </div>
            `;
        }
        
        function renderPrivateChatMessage(message, isOwnMessage) {
            // FIX: Corrected img src
            const avatar = "https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?w=100&h=100&fit=crop";
            
            if (isOwnMessage) {
                return `
                <div class="flex items-end gap-3 p-0 justify-end">
                    <div class="flex flex-1 flex-col gap-1 items-end">
                        <p class="text-text-muted-light dark:text-text-muted-dark text-[13px] font-medium text-right">You</p>
                        <p class="text-base font-normal leading-relaxed flex max-w-[480px] rounded-lg rounded-br-none px-4 py-3 bg-bubble-user-light dark:bg-bubble-user-dark text-text-light dark:text-text-dark">
                            ${message.message_text}
                        </p>
                    </div>
                    <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0" src="${avatar}">
                </div>
                `;
            }
            
            // Other user's message
            return `
                <div class="flex items-end gap-3 p-0">
                    <img class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 h-10 shrink-0" src="${avatar}">
                    <div class="flex flex-1 flex-col gap-1 items-start">
                        <p class="text-primary dark:text-primary-accent text-[13px] font-medium">${message.sender_email.split('@')[0]}</p>
                        <p class="text-base font-normal leading-relaxed flex max-w-[480px] rounded-lg rounded-bl-none px-4 py-3 bg-bubble-light dark:bg-bubble-dark text-text-light dark:text-text-dark">
                            ${message.message_text}
                        </p>
                    </div>
                </div>
            `;
        }

        // --- EVENT LISTENER ATTACHMENT FUNCTIONS ---
        
        function attachLoginListeners() {
            const loginForm = document.getElementById('login-form');
            if (!loginForm) return;
            const errorEl = document.getElementById('error-message');
            const buttonEl = document.getElementById('login-button');
            loginForm.onsubmit = async (e) => {
                e.preventDefault();
                errorEl.classList.add('hidden');
                buttonEl.textContent = "Logging in...";
                buttonEl.disabled = true;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || 'Login failed');
                    localStorage.setItem('token', data.access_token);
                    const userData = parseJwt(data.access_token);
                    const userToStore = { email: userData.sub, role: userData.role, id: userData.id };
                    localStorage.setItem('user', JSON.stringify(userToStore));
                    window.location.hash = '#dashboard';
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                    buttonEl.textContent = "Log In";
                    buttonEl.disabled = false;
                }
            };
        }
        
        function attachRegisterListeners() {
            const registerForm = document.getElementById('register-form');
            if (!registerForm) return;
            const errorEl = document.getElementById('error-message');
            const successEl = document.getElementById('success-message');
            const buttonEl = document.getElementById('register-button');
            registerForm.onsubmit = async (e) => {
                e.preventDefault();
                errorEl.classList.add('hidden');
                successEl.classList.add('hidden');
                buttonEl.textContent = "Creating Account...";
                buttonEl.disabled = true;
                const fullName = document.getElementById('fullName').value;
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const role = document.querySelector('input[name="role"]:checked').value;
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ fullName, email, password, role })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || 'Registration failed');
                    successEl.textContent = "Success! Redirecting to login...";
                    successEl.classList.remove('hidden');
                    setTimeout(() => { window.location.hash = '#login'; }, 2000);
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                    buttonEl.textContent = "Create My Account";
                    buttonEl.disabled = false;
                }
            };
        }
        
        function attachDashboardListeners() {
            const logoutButton = document.getElementById('logout-button');
            if(logoutButton) {
                logoutButton.onclick = () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.hash = '#login';
                };
            }
        }

        function attachAiAssistantListeners() {
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const messageFeed = document.getElementById('message-feed');
            const fileButton = document.getElementById('file-button');
            const fileInput = document.getElementById('file-input');
            if (!chatForm || !messageFeed) return;
            
            const scrollToBottom = () => messageFeed.scrollTop = messageFeed.scrollHeight;
            const handleError = (errorMessage) => {
                const errorMsg = { sender: 'ai', text: `Sorry, an error occurred: ${errorMessage}` };
                aiChatHistory.push(errorMsg);
                document.getElementById('typing-indicator')?.remove();
                messageFeed.innerHTML += renderAiChatMessage(errorMsg.sender, errorMsg.text);
                scrollToBottom();
            };
            const fetchAiResponse = async (query, imageUrl) => {
                messageFeed.innerHTML += renderAiTypingIndicator();
                scrollToBottom();
                try {
                    const response = await fetch(`${API_BASE_URL}/ai-assistant/ask`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ query, image_url: imageUrl })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.detail || 'AI error');
                    const aiMessage = { sender: 'ai', text: data.response };
                    aiChatHistory.push(aiMessage);
                    document.getElementById('typing-indicator')?.remove();
                    messageFeed.innerHTML += renderAiChatMessage(aiMessage.sender, aiMessage.text);
                    scrollToBottom();
                } catch (err) {
                    handleError(err.message);
                }
            };
            const handleSend = async (e) => {
                e.preventDefault();
                const query = chatInput.value;
                if (query.trim() === '') return;
                chatInput.value = '';
                aiChatHistory.push({ sender: 'user', text: query });
                messageFeed.innerHTML += renderAiChatMessage('user', query);
                await fetchAiResponse(query, null);
            };
            const handleAttachment = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const query = chatInput.value;
                chatInput.value = '';
                messageFeed.innerHTML += renderAiTypingIndicator();
                scrollToBottom();
                try {
                    // 1. Get signature from our backend
                    const sigResponse = await fetch(`${API_BASE_URL}/uploads/request-cloudinary-signature`, { method: 'POST', headers: getAuthHeaders() });
                    const sigData = await sigResponse.json();
                    if (!sigResponse.ok) throw new Error(sigData.detail || 'Failed to get upload signature');
                    
                    // 2. Upload to Cloudinary
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('api_key', sigData.api_key);
                    formData.append('timestamp', sigData.timestamp);
                    formData.append('signature', sigData.signature);
                    formData.append('folder', sigData.folder);
                    const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${sigData.cloud_name}/image/upload`;
                    const cloudinaryResponse = await fetch(cloudinaryUrl, { method: 'POST', body: formData });
                    const cloudinaryData = await cloudinaryResponse.json();
                    if (!cloudinaryResponse.ok) throw new Error(cloudinaryData.error.message || 'Cloudinary upload failed');
                    
                    // 3. Send URL to our backend
                    const finalImageUrl = cloudinaryData.secure_url;
                    const userMessage = { sender: 'user', text: query || "Here's my plant, please diagnose it.", imageUrl: finalImageUrl };
                    aiChatHistory.push(userMessage);
                    document.getElementById('typing-indicator')?.remove();
                    messageFeed.innerHTML += renderAiChatMessage(userMessage.sender, userMessage.text, userMessage.imageUrl);
                    await fetchAiResponse(userMessage.text, finalImageUrl);
                } catch (err) {
                    handleError(err.message);
                }
            };
            chatForm.onsubmit = handleSend;
            fileButton.onclick = () => fileInput.click();
            fileInput.onchange = handleAttachment;
            scrollToBottom();
        }
        
        function attachCreateListingListeners() {
            const form = document.getElementById('listing-form');
            const fileInput = document.getElementById('listing-images');
            const previewContainer = document.getElementById('image-preview-container');
            const errorEl = document.getElementById('error-message');
            const successEl = document.getElementById('success-message');
            const buttonEl = document.getElementById('listing-submit-button');
            if (!form) return;
            listingFiles = []; // Reset on page load
            const renderFilePreviews = () => {
                previewContainer.innerHTML = '';
                listingFiles.forEach((file, index) => {
                    const badge = document.createElement('div');
                    badge.className = 'file-preview-badge';
                    badge.innerHTML = `<span>${file.name}</span><span class="file-preview-badge-remove" data-index="${index}"><span class="material-symbols-outlined" style="font-size: 16px;">close</span></span>`;
                    previewContainer.appendChild(badge);
                });
                previewContainer.querySelectorAll('.file-preview-badge-remove').forEach(btn => {
                    btn.onclick = (e) => {
                        const indexToRemove = parseInt(e.currentTarget.dataset.index);
                        listingFiles = listingFiles.filter((_, i) => i !== indexToRemove);
                        renderFilePreviews();
                    };
                });
            };
            fileInput.onchange = (e) => {
                listingFiles.push(...Array.from(e.target.files));
                renderFilePreviews();
            };
            form.onsubmit = async (e) => {
                e.preventDefault();
                errorEl.classList.add('hidden');
                successEl.classList.add('hidden');
                if (listingFiles.length < 3) {
                    errorEl.textContent = "Please upload at least 3 images.";
                    errorEl.classList.remove('hidden');
                    return;
                }
                buttonEl.textContent = "1/3: Requesting Upload Signature...";
                buttonEl.disabled = true;
                try {
                    // 1. Get signature
                    const sigResponse = await fetch(`${API_BASE_URL}/uploads/request-cloudinary-signature`, { method: 'POST', headers: getAuthHeaders() });
                    const sigData = await sigResponse.json();
                    if (!sigResponse.ok) throw new Error(sigData.detail || 'Failed to get upload signature');
                    
                    // 2. Upload files
                    buttonEl.textContent = "2/3: Uploading Images (0%)...";
                    const uploadedImageUrls = [];
                    const totalFiles = listingFiles.length;
                    for (let i = 0; i < totalFiles; i++) {
                        const file = listingFiles[i];
                        const percent = Math.round(((i + 1) / totalFiles) * 100);
                        buttonEl.textContent = `2/3: Uploading Images (${percent}%)...`;
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('api_key', sigData.api_key);
                        formData.append('timestamp', sigData.timestamp);
                        formData.append('signature', sigData.signature);
                        formData.append('folder', sigData.folder);
                        const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${sigData.cloud_name}/image/upload`;
                        const cloudinaryResponse = await fetch(cloudinaryUrl, { method: 'POST', body: formData });
                        const cloudinaryData = await cloudinaryResponse.json();
                        if (!cloudinaryResponse.ok) throw new Error(cloudinaryData.error.message || 'Cloudinary upload failed');
                        uploadedImageUrls.push(cloudinaryData.secure_url);
                    }
                    
                    // 3. Submit listing to our backend
                    buttonEl.textContent = "3/3: Submitting for YOLO grading...";
                    const listingPayload = {
                        title: document.getElementById('title').value,
                        location: document.getElementById('location').value,
                        quantity: parseFloat(document.getElementById('quantity').value),
                        quantity_unit: document.getElementById('quantity_unit').value,
                        harvest_date: document.getElementById('harvest_date').value,
                        image_urls: uploadedImageUrls
                    };
                    const finalResponse = await fetch(`${API_BASE_URL}/listings/create`, { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(listingPayload) });
                    const finalData = await finalResponse.json();
                    if (!finalResponse.ok) throw new Error(finalData.detail || 'Failed to create listing');
                    successEl.textContent = `Success! YOLO Grade: ${finalData.ai_grading.grade}. Redirecting...`;
                    successEl.classList.remove('hidden');
                    buttonEl.textContent = "Success!";
                    setTimeout(() => { window.location.hash = '#dashboard'; }, 3000);
                } catch (err) {
                    errorEl.textContent = err.message;
                    errorEl.classList.remove('hidden');
                    buttonEl.textContent = "Submit for YOLO Grading";
                    buttonEl.disabled = false;
                }
            };
        }
        
        // --- NEW: ATTACH LISTENERS FOR CHAT PAGE ---
        function attachChatListeners(chatId) {
            const messageFeed = document.getElementById('chat-message-feed');
            const chatForm = document.getElementById('private-chat-form');
            const chatInput = document.getElementById('private-chat-input');
            const sendButton = document.getElementById('private-chat-send-button');
            
            if (!chatForm || !messageFeed) return;

            let currentMessages = []; // Store messages to avoid full re-render
            
            const scrollToBottom = () => {
                if(messageFeed) messageFeed.scrollTop = messageFeed.scrollHeight;
            }
            
            const renderMessages = (messages) => {
                if (messages.length === 0) {
                    messageFeed.innerHTML = `<p class="text-center text-text-muted-light">This is the start of your conversation. Send a message to make an offer!</p>`;
                    return;
                }
                // Only render new messages
                const newMessages = messages.slice(currentMessages.length);
                
                // Clear loading text on first load
                if (currentMessages.length === 0 && messageFeed.innerHTML.includes("Loading messages...")) {
                     messageFeed.innerHTML = '';
                }

                newMessages.forEach(msg => {
                    const isOwn = msg.sender_email === currentUser.email;
                    messageFeed.innerHTML += renderPrivateChatMessage(msg, isOwn);
                });
                
                if (currentMessages.length === 0) { // First load
                     scrollToBottom();
                }
                currentMessages = messages; // Update our cache
            };
            
            const fetchMessages = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/chat/${chatId}/messages`, {
                        method: 'GET',
                        headers: getAuthHeaders()
                    });
                    const messages = await response.json();
                    if (!response.ok) {
                        throw new Error(messages.detail || 'Failed to fetch messages');
                    }
                    
                    renderMessages(messages);
                    
                } catch (err) {
                    messageFeed.innerHTML = `<p class="text-center text-red-600">Error: ${err.message}</p>`;
                    if (messagePollingInterval) clearInterval(messagePollingInterval); // Stop polling on error
                }
            };
            
            chatForm.onsubmit = async (e) => {
                e.preventDefault();
                const text = chatInput.value;
                if (text.trim() === '') return;
                
                chatInput.value = '';
                chatInput.disabled = true;
                sendButton.disabled = true;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/chat/${chatId}/send`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ message_text: text })
                    });
                    const newMessage = await response.json();
                    if (!response.ok) throw new Error(newMessage.detail || 'Failed to send');
                    
                    // Manually add our new message to avoid waiting for poll
                    const isOwn = newMessage.sender_email === currentUser.email;
                    messageFeed.innerHTML += renderPrivateChatMessage(newMessage, isOwn);
                    currentMessages.push(newMessage); // Add to cache
                    scrollToBottom();
                    
                } catch (err) {
                    alert(`Error sending message: ${err.message}`);
                    chatInput.value = text; // Put text back
                } finally {
                    chatInput.disabled = false;
                    sendButton.disabled = false;
                    chatInput.focus();
                }
            };
            
            // --- Initial Load & Polling ---
            fetchMessages(); // Load messages immediately
            // Poll for new messages every 5 seconds
            messagePollingInterval = setInterval(fetchMessages, 5000); 
        }

        // --- Initial Load ---
        window.addEventListener('hashchange', router);
        router(); // Call on initial load

    </script>
</body>
</html>